#Filesystem trimming: Linux On Azure  ( Premium storage-SSD)
##WHAT IS TRIMMING?
A trim command (known as TRIM in the ATA command set, and UNMAP in the SCSI command set) allows an operating system to inform a solid-state drive (SSD) which blocks of data are no longer considered in use and can be wiped internally:

> wikipedia

SSD drives are composed of groups of Flash (NAND) memory cells. Three major differences from traditional magnetic disks can affect the performance of SSD drives:

Memory cells cannot be overwritten in one operation: existing data need to be erased first before they can be replaced with new data.
Memory cells support a limited number of program/erase cycles.
Memory cells are organized in pages and blocks and SSD drives can only erase entire blocks!
These limitations have forced manufacturers to implement Garbage Collection where blocks containing both pages with data and pages marked for deletion are emptied after copying pages with data to free blocks. Therefore SSD drives, internally, create more IO than explicitly generated by the OS for write operations; this phenomenon is called write amplification.

When the OS gets a request to delete a file, the filesystem only updates metadata and doesn’t erase the disk addresses holding the actual data. This worsens write amplification on SSD drives during GC runs. 
To address this problem, OSes can issue the TRIM command to make the SSD drive aware of erased data; this brings two advantages:

Prevents unnecessary data movement (of data already erased by the OS) during GC runs
Improves the efficiency of GC due to more free space available

Basically, SSD drives will operate faster if the filesystem passes information to them about files that have been deleted.

we can enable TRIM in two ways on a linux VM:
1. Continuous TRIM - by setting a mount option discard flag on the /etc/fstab file – do you know if this has some implementation of ionice (what priority is assigned if there is contention for IO)
2. Periodic TRIM – using cron to run a fstrim on the file system.

##TRIMMING on Linux vms In Azure 

Both ways are possible in azure and yes Continuous TRIM might seem easier. However, it is recommended to use periodic trimming as certain applications could have performance implications. This would entirely depend upon the type of application being used.
Refer to the following links on how to implement it

* [impement fstrim in linux systems on azure](https://docs.microsoft.com/en-us/azure/virtual-machines/virtual-machines-linux-classic-attach-disk)

* [Implement fstrim in linux systems on azure](https://docs.microsoft.com/en-us/azure/virtual-machines/virtual-machines-linux-configure-lvm)
	

On CentOS-7+ the fstrim.service and associated systemd timer is disabled by default, so you will need to enable the service and probably override the default timer schedule as well.

If you are using LVM and frequently perform resize operations you will need to set issue_discards to 1 in /etc/lvm/lvm.conf. 

Trimming capability is supported in SSD in azure which file systems can use to clear the memory occupied by deleted files. this helps in cost optimization as Page blobs are implemented as sparse storage which means that only pages that have actually been written to are stored and billed for

In short, 
	- The VHDs used by OS disks and data disks are persisted as page blobs in Azure Storage. 
	- Page blobs are implemented as sparse storage which means that only pages that have actually been written to are stored and billed for.
	- TRIM is a cost optimization not a performance optimization. For better performance optimization with SSDs, I would recommend implementing RAID


Additional detailed references:

https://www.digitalocean.com/community/tutorials/how-to-configure-periodic-trim-for-ssd-storage-on-linux-servers
